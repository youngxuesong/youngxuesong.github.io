class LocalSearch{constructor({path:e="",unescape:t=false,top_n_per_article:n=1}){this.path=e;this.unescape=t;this.top_n_per_article=n;this.isfetched=false;this.datas=null}getIndexByWord(e,i,r=false){const c=[];const a=new Set;if(!r){i=i.toLowerCase()}e.forEach(e=>{if(this.unescape){const o=document.createElement("div");o.innerText=e;e=o.innerHTML}const t=e.length;if(t===0)return;let n=0;let s=-1;if(!r){e=e.toLowerCase()}while((s=i.indexOf(e,n))>-1){c.push({position:s,word:e});a.add(e);n=s+t}});c.sort((e,t)=>{if(e.position!==t.position){return e.position-t.position}return t.word.length-e.word.length});return[c,a]}mergeIntoSlice(e,t,n){let s=n[0];let{position:o,word:i}=s;const r=[];const c=new Set;while(o+i.length<=t&&n.length!==0){c.add(i);r.push({position:o,length:i.length});const a=o+i.length;n.shift();while(n.length!==0){s=n[0];o=s.position;i=s.word;if(a>o){n.shift()}else{break}}}return{hits:r,start:e,end:t,count:c.size}}highlightKeyword(e,t){let n="";let s=t.start;for(const{position:o,length:i}of t.hits){n+=e.substring(s,o);s=o+i;n+=`<mark class="search-keyword">${e.substr(o,i)}</mark>`}n+=e.substring(s,t.end);return n}getResultItems(w){const y=[];this.datas.forEach(({title:e,content:t,url:n})=>{const[s,o]=this.getIndexByWord(w,e);const[i,r]=this.getIndexByWord(w,t);const c=new Set([...o,...r]).size;const a=s.length+i.length;if(a===0)return;const l=[];if(s.length!==0){l.push(this.mergeIntoSlice(0,e.length,s))}let h=[];while(i.length!==0){const g=i[0];const{position:p}=g;const f=Math.max(0,p-20);const m=Math.min(t.length,p+100);h.push(this.mergeIntoSlice(f,m,i))}h.sort((e,t)=>{if(e.count!==t.count){return t.count-e.count}else if(e.hits.length!==t.hits.length){return t.hits.length-e.hits.length}return e.start-t.start});const d=parseInt(this.top_n_per_article,10);if(d>=0){h=h.slice(0,d)}let u="";n=new URL(n,location.origin);n.searchParams.append("highlight",w.join(" "));if(l.length!==0){u+=`<li class="local-search-hit-item"><a href="${n.href}"><span class="search-result-title">${this.highlightKeyword(e,l[0])}</span>`}else{u+=`<li class="local-search-hit-item"><a href="${n.href}"><span class="search-result-title">${e}</span>`}h.forEach(e=>{u+=`<p class="search-result">${this.highlightKeyword(t,e)}...</p></a>`});u+="</li>";y.push({item:u,id:y.length,hitCount:a,includedCount:c})});return y}fetchData(){const t=!this.path.endsWith("json");fetch(this.path).then(e=>e.text()).then(e=>{this.isfetched=true;this.datas=t?[...(new DOMParser).parseFromString(e,"text/xml").querySelectorAll("entry")].map(e=>({title:e.querySelector("title").textContent,content:e.querySelector("content").textContent,url:e.querySelector("url").textContent})):JSON.parse(e);this.datas=this.datas.filter(e=>e.title).map(e=>{e.title=e.title.trim();e.content=e.content?e.content.trim().replace(/<[^>]+>/g,""):"";e.url=decodeURIComponent(e.url).replace(/\/{2,}/g,"/");return e});window.dispatchEvent(new Event("search:loaded"))})}highlightText(t,e,n){const s=t.nodeValue;let o=e.start;const i=[];for(const{position:r,length:c}of e.hits){const a=document.createTextNode(s.substring(o,r));o=r+c;const l=document.createElement("mark");l.className=n;l.appendChild(document.createTextNode(s.substr(r,c)));i.push(a,l)}t.nodeValue=s.substring(o,e.end);i.forEach(e=>{t.parentNode.insertBefore(e,t)})}highlightSearchWords(e){const t=new URL(location.href).searchParams.get("highlight");const s=t?t.split(" "):[];if(!s.length||!e)return;const n=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null);const o=[];while(n.nextNode()){if(!n.currentNode.parentNode.matches("button, select, textarea, .mermaid"))o.push(n.currentNode)}o.forEach(e=>{const[t]=this.getIndexByWord(s,e.nodeValue);if(!t.length)return;const n=this.mergeIntoSlice(0,e.nodeValue.length,t);this.highlightText(e,n,"search-keyword")})}}window.addEventListener("load",()=>{const{path:e,top_n_per_article:t,unescape:n,languages:r}=GLOBAL_CONFIG.localSearch;const c=new LocalSearch({path:e,top_n_per_article:t,unescape:n});const a=document.querySelector("#local-search-input input");const l=document.getElementById("local-search-stats-wrap");const h=document.getElementById("loading-status");const d=!e.endsWith("json");const s=()=>{if(!c.isfetched)return;let e=a.value.trim().toLowerCase();d&&(e=e.replace(/</g,"&lt;").replace(/>/g,"&gt;"));if(e!=="")h.innerHTML='<i class="fas fa-spinner fa-pulse"></i>';const t=e.split(/[-\s]+/);const n=document.getElementById("local-search-results");let s=[];if(e.length>0){s=c.getResultItems(t)}if(t.length===1&&t[0]===""){n.textContent="";l.textContent=""}else if(s.length===0){n.textContent="";const o=document.createElement("div");o.className="search-result-stats";o.textContent=r.hits_empty.replace(/\$\{query}/,e);l.innerHTML=o.outerHTML}else{s.sort((e,t)=>{if(e.includedCount!==t.includedCount){return t.includedCount-e.includedCount}else if(e.hitCount!==t.hitCount){return t.hitCount-e.hitCount}return t.id-e.id});const i=r.hits_stats.replace(/\$\{hits}/,s.length);n.innerHTML=`<ol class="search-result-list">${s.map(e=>e.item).join("")}</ol>`;l.innerHTML=`<hr><div class="search-result-stats">${i}</div>`;window.pjax&&window.pjax.refresh(n)}h.textContent=""};let o=false;const i=document.getElementById("search-mask");const u=document.querySelector("#local-search .search-dialog");const g=()=>{if(window.innerWidth<768){u.style.setProperty("--search-height",window.innerHeight+"px")}};const p=()=>{btf.overflowPaddingR.add();btf.animateIn(i,"to_show 0.5s");btf.animateIn(u,"titleScale 0.5s");setTimeout(()=>{a.focus()},300);if(!o){!c.isfetched&&c.fetchData();a.addEventListener("input",s);o=true}document.addEventListener("keydown",function e(t){if(t.code==="Escape"){f();document.removeEventListener("keydown",e)}});g();window.addEventListener("resize",g)};const f=()=>{btf.overflowPaddingR.remove();btf.animateOut(u,"search_close .5s");btf.animateOut(i,"to_hide 0.5s");window.removeEventListener("resize",g)};const m=()=>{btf.addEventListenerPjax(document.querySelector("#search-button > .search"),"click",p)};const w=()=>{document.querySelector("#local-search .search-close-button").addEventListener("click",f);i.addEventListener("click",f);if(GLOBAL_CONFIG.localSearch.preload){c.fetchData()}c.highlightSearchWords(document.getElementById("article-container"))};window.addEventListener("search:loaded",()=>{const e=document.getElementById("loading-database");e.nextElementSibling.style.display="block";e.remove()});m();w();window.addEventListener("pjax:complete",()=>{!btf.isHidden(i)&&f();c.highlightSearchWords(document.getElementById("article-container"));m()})});